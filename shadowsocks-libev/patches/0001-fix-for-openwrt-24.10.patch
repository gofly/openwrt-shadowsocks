From 439244befba1a8349609225363554534a4d3ed26 Mon Sep 17 00:00:00 2001
From: zhenglixin <lixin.zhenglx@gmail.com>
Date: Sun, 21 Sep 2025 14:30:27 +0800
Subject: [PATCH 1/6] fix for openwrt 24.10

---
 configure.ac   | 49 ++++++++++++++++++++++++++++++++++++++-----------
 src/udprelay.c |  1 -
 2 files changed, 38 insertions(+), 12 deletions(-)
 mode change 100755 => 100644 configure.ac

diff --git a/configure.ac b/configure.ac
old mode 100755
new mode 100644
index 134ea5f..564332d
--- a/configure.ac
+++ b/configure.ac
@@ -1,8 +1,8 @@
 dnl                                               -*- Autoconf -*-
 dnl Process this file with autoconf to produce a configure script.
 
-AC_PREREQ([2.67])
-AC_INIT([shadowsocks-libev], [3.3.5], [max.c.lv@gmail.com])
+AC_PREREQ([2.71])
+AC_INIT([shadowsocks-libev],[3.3.5],[max.c.lv@gmail.com])
 AC_CONFIG_SRCDIR([src/crypto.c])
 AC_CONFIG_HEADERS([config.h])
 AC_CONFIG_AUX_DIR(auto)
@@ -102,11 +102,6 @@ case $host in
     ;;
 esac
 
-dnl Checks for pthread
-AX_PTHREAD([LIBS="$PTHREAD_LIBS $LIBS"
-            CFLAGS="$CFLAGS $PTHREAD_CFLAGS"
-            CC="$PTHREAD_CC"], AC_MSG_ERROR(Can not find pthreads.  This is required.))
-
 dnl Checks for stack protector
 GGL_CHECK_STACK_PROTECTOR([has_stack_protector=yes], [has_stack_protector=no])
 # XXX - disable -fstack-protector due to missing libssp_nonshared
@@ -204,7 +199,15 @@ AC_TYPE_SSIZE_T
 
 dnl Checks for header files.
 AC_HEADER_ASSERT
-AC_HEADER_STDC
+m4_warn([obsolete],
+[The preprocessor macro `STDC_HEADERS' is obsolete.
+  Except in unusual embedded environments, you can safely include all
+  ISO C90 headers unconditionally.])dnl
+# Autoupdate added the next two lines to ensure that your configure
+# script's behavior did not change.  They are probably safe to remove.
+AC_CHECK_INCLUDES_DEFAULT
+AC_PROG_EGREP
+
 AC_HEADER_SYS_WAIT
 
 dnl Checks for typedefs, structures, and compiler characteristics.
@@ -214,12 +217,37 @@ AC_TYPE_SIZE_T
 AC_TYPE_SSIZE_T
 AC_TYPE_UINT16_T
 AC_TYPE_UINT8_T
-AC_HEADER_TIME
+m4_warn([obsolete],
+[Update your code to rely only on HAVE_SYS_TIME_H,
+then remove this warning and the obsolete code below it.
+All current systems provide time.h; it need not be checked for.
+Not all systems provide sys/time.h, but those that do, all allow
+you to include it and time.h simultaneously.])dnl
+AC_CHECK_HEADERS_ONCE([sys/time.h])
+# Obsolete code to be removed.
+if test $ac_cv_header_sys_time_h = yes; then
+  AC_DEFINE([TIME_WITH_SYS_TIME],[1],[Define to 1 if you can safely include both <sys/time.h>
+	     and <time.h>.  This macro is obsolete.])
+fi
+# End of obsolete code.
+
 
 dnl Checks for library functions.
 AC_FUNC_FORK
 AC_FUNC_SELECT_ARGTYPES
-AC_TYPE_SIGNAL
+m4_warn([obsolete],
+[your code may safely assume C89 semantics that RETSIGTYPE is void.
+Remove this warning and the `AC_CACHE_CHECK' when you adjust the code.])dnl
+AC_CACHE_CHECK([return type of signal handlers],[ac_cv_type_signal],[AC_COMPILE_IFELSE(
+[AC_LANG_PROGRAM([#include <sys/types.h>
+#include <signal.h>
+],
+		 [return *(signal (0, 0)) (0) == 1;])],
+		   [ac_cv_type_signal=int],
+		   [ac_cv_type_signal=void])])
+AC_DEFINE_UNQUOTED([RETSIGTYPE],[$ac_cv_type_signal],[Define as the return type of signal handlers
+		    (`int' or `void').])
+
 AC_CHECK_FUNCS([memset select setresuid setreuid strerror get_current_dir_name getpwnam_r setrlimit])
 
 AC_CHECK_LIB(socket, connect)
@@ -234,7 +262,6 @@ AC_ARG_WITH(ev,
    LDFLAGS="$LDFLAGS -L$withval/lib"]
 )
 AC_CHECK_HEADERS([ev.h libev/ev.h], [], [])
-AC_CHECK_LIB([ev], [ev_loop_destroy], [LIBS="-lev $LIBS"], [AC_MSG_ERROR([Couldn't find libev. Try installing libev-dev@<:@el@:>@.])])
 
 AC_CONFIG_FILES([shadowsocks-libev.pc
                  Makefile
diff --git a/src/udprelay.c b/src/udprelay.c
index 5de3883..49ce98a 100644
--- a/src/udprelay.c
+++ b/src/udprelay.c
@@ -1434,7 +1434,6 @@ void
 free_cb(void *key, void *element)
 {
     remote_ctx_t *remote_ctx = (remote_ctx_t *)element;
-
     if (verbose) {
         LOGI("[udp] one connection freed");
     }
-- 
2.37.1 (Apple Git-137.1)

